---
layout: article
title:  "理解Groth16，一些细节上的说明"
date:   2022-03-22 10:00:00 +0800
tags: Blockchain ZKP Groth16
categories: zk-SNARK
---

V神曾经写过一篇非常好的介绍R1CS与QAP问题的文章。但是，对于不熟悉密码学的，或者说密码学思想的票友们来说，文章中的一些逻辑上的跨度还是大了一些。尤其是在R1CS转换成多项式形式的地方，初次接触的人可能会一脸懵逼。本文，我就从我的理解来谈一谈，从R1CS到QAP这一过程。

前面的步骤我们都很好理解，在Groth16的流程中，我们首先把计算问题拍平成电路，然后根据电路，来构造R1CS约束。

这里我们直接使用V神的[博客](https://vitalik.ca/general/2016/12/10/qap.html)中的例子。下面的三个矩阵是R1CS的约束矩阵，

```
A
[0, 1, 0, 0, 0, 0]
[0, 0, 0, 1, 0, 0]
[0, 1, 0, 0, 1, 0]
[5, 0, 0, 0, 0, 1]

B
[0, 1, 0, 0, 0, 0]
[0, 1, 0, 0, 0, 0]
[1, 0, 0, 0, 0, 0]
[1, 0, 0, 0, 0, 0]

C
[0, 0, 0, 1, 0, 0]
[0, 0, 0, 0, 1, 0]
[0, 0, 0, 0, 0, 1]
[0, 0, 1, 0, 0, 0]
```

这三个矩都包含了四个行向量，代表了原始的计算被拍平成了在R1CS约束下的四个电路。我们用$S$来表示我们知道的Solution向量。

```
1
3
35
9
27
30
```

如果我们想证明我们知道原始计算的一个解，那么就需要证明A，B，C矩阵中的行向量与解向量$S$的内积之后的值是符合R1CS约束的：

$（A_i*S）* (B_i*S) - C_i*S = 0$

在接下来的一步，我们需要将R1CS的约束转换成一个QAP问题，这个地方是理解zk的重点。我觉得原文中没有提到的一点时，我们为什么要这么做的？为什么要把R1CS仔进行转换？这样的做的目的是什么？V神的原文只描述了如何做，如何进行拉普拉斯插值求多项式，所以第一次读到这里的时候，我感觉一头雾水。

这样做的原因是，在R1CS约束中，我们只能一个电路门，一个电路门的，使用列向量与解向量的内积来验证R1CS的约束是否是正确的。这样在方式在大规模约束下显然是十分低效的。那么接下来的思考方向就变成了，存不存在一种办法，可以让我们**一次计算**来验证所有约束的正确性？这也就是解下来引出的从R1CS到QAP问题。

如果我们观察上面的约束，我们会发现解向量中$S$中的S1元素，一定与A11，A21，A31，A41这四个元素相乘。那么我们假设存在一个多项式$A_1(x)$，它经过(1,0),(2,0),(3,0),(4,5)这四个点。这个多项式$A_1(x)$的数学意义是当x的值为1时，它的值为0，当$x=2$时，多项式的值为0，当$x=3$时，多项式的值为0，当$x=4$时，多项式的值为5。这样，我们通过引入额外的参数x，使得我们可以使用一个的多项式$A_1(x)$来描述[A11，A21，A31，A41]这四个值。

根据拉普拉斯插值法我们可以求出关于[A11，A21，A31，A41]的多项式为：
$A_1(x) = 0.833*x^3 -5.0 * x^2 +9.166 *x -5.0$。
当x取1时，A_1(x)的值为0，显然等于R1CS约束矩阵中的A11的值。

同样的，我们可以构造出其他列向量的多项式$A_i(x),B_i(x),C_i(x)$。那么这样，我们就可以使用这几个多项式来描述R1CS的内积。

$$
((1 * A_1(x))+(3 * A_2(x))+(35 * A_3(x)) + (9 * A_4(x)) +(27 * A_5(x))+(30 * A_6(x))) \\ *（(1 * B_1(x)+(3 * B_2(x))+(35 * B_3(x)) + (9 * B_4(x)) +(27 * B_5(x))+(30 * B_6(x))) \\ - （(1 * C_1(x)+(3 * C_2(x))+(35 * C_3(x)) + (9 * C_4(x)) +(27 * C_5(x))+(30 * C_6(x)))
$$

现在我们已经将实际的值转换成了多项式，根据x的取值的不同，来描述不同的R1CS约束。更进一步的来说，因为上面的式子中都是多项式，我们可以把它门展开成一个更简洁的式$t(x)$:

$t(x) = (-5.166*x^3+38.5*x^2-73.333*x+43)*(0.666*x^3-5.0*x^2+10.333*x-3.0)-(2.833*x^3-24.5*x^2+10.333*x-41.0)$
$t(x) = -3.440556x^6+51.471x^5-294.720056x^4+805.7885x^3-1063.749889x^2+592.652x-88$

同时我们需要让右边的值等于0。因为x的取值只有1，2，3，4，我们就可以构造一个多项式$z(x)=(x-1)(x-2)(x-3)(x-4)$。显然$z(x)$在x可能的取值情况下都等于0。这里，一个$z(x)$是不足以等于$t(x)$，所以我们引入另一个多项式$h(x)$，使得$t(x)=z(x)h(x)$。

这样我们就实现了用一个多项式来描述所有的R1CS的约束了。我们可以设置x值取1，2，3，4，来验证对应的电路的R1CS约束是不是合法。

更为神奇的是，通过这个过程我们完美的隐藏掉了原来解向量$S$的存在。我们只需要提供一个多项式$t(x)$使得$t(x)=z(x)h(x)$在x等于1，2，3，4都成立，我们同样可以得到与R1CS向量内积一样的结论。这样我们就完成了前期的零知识问题的转换。